name: test

on:
  push:
    branches: [test]

concurrency:
  group: ci-testing-${{ github.ref }}
  cancel-in-progress: false

jobs:

  package:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1

      - name: fpm
        run: |
          gem install fpm
          fpm --version

      - name: download
        run: |
          wget -c https://github.com/prometheus/node_exporter/releases/download/v1.3.1/node_exporter-1.3.1.linux-amd64.tar.gz
          wget -c https://github.com/prometheus/node_exporter/releases/download/v1.3.1/sha256sums.txt
          sha256sum --check --ignore-missing sha256sums.txt

      - name: systemd
        run: |
          cat >node_exporter.service <<EOF
          # https://github.com/prometheus/node_exporter/blob/master/examples/systemd/node_exporter.service
          [Unit]
          Description=Node Exporter

          [Service]
          User=node_exporter
          EnvironmentFile=/etc/sysconfig/node_exporter
          ExecStart=/usr/sbin/node_exporter $OPTIONS

          [Install]
          WantedBy=multi-user.target
          EOF

      - name: package
        run: |
          tar xvfz node_exporter-*.*-amd64.tar.gz
          cd node_exporter-*.*-amd64
          cp ../node_exporter.service .
          fpm \
            --input-type dir \
            --output-type deb \
            --prefix /usr/local/bin \
            --name node_exporter \
            --architecture amd64 \
            --version 1.3.1 \
            LICENSE=/usr/share/doc/node-exporter/LICENSE \
            NOTICE=/usr/share/doc/node-exporter/NOTICE \
            node_exporter=/usr/local/bin/node_exporter \
            node_exporter.service=/etc/systemd/system/node_exporter.service
          ls -l
          dpkg --contents node-exporter_1.3.1_amd64.deb

      - uses: finnp/create-file-action@master
        env:
          FILE_NAME: KEY.gpg
          FILE_BASE64: LS0tLS1CRUdJTiBQR1AgUFVCTElDIEtFWSBCTE9DSy0tLS0tCgptUUdOQkdBa29yMEJEQUR0RW1tZUVXQ2lKYlM0T2dyU0JFa0V5TG9CVXcvU3kwZThPVlNvMVBMb3hvaDZLdDZyCmtWd1FXMWplQm0zVitVNG5nUTF2SkUvU0YvNFBDU2xyd2Q2WTAzTHorL1d3UUdSSmVZdGlrMDRhcVBPQktBUmoKS2tSUEk2T3RaNG9IdkljZ2pWdEN2ZDYyTnEwZE40blIySVBST3M4U0wyWm9FZzdHMlFoRFZFVk00b1ExeVZBaQpsaUdmcXQ2Q2hyREdhOVNXVDlSbXBVbHQ0N3dzS0FRakdZWlNhaGJiVXpEODB6QzV0VmdLRWg2dlMwaVlHc3EyCklyVWVndWw3UjAvbU1BODJtRHREY3I4N084VVJ1bFNMdi9SOWlrYWNpTllIbkNsWXhia21veUhuWmlsdDExRloKd2RzRGdNRno5bDYvYXZKbko0UFZ1MzNERjlKY0ZrRWtoMUtKQnorT2QwTU00Si9jVGlSejNaYUxzOHk1b1MyegpWdG4vaC9XU0l4ck0renZ0OEVjK3Z4RWF1M0ExaEgwRmFRSld6aWs4eDVhelp2a3lIcDRBWU5NY3ZBdmIzc1lQCnIyZDlMRGJWYTF3YjE1T2ZOOUwxdlIxQ29haVVXVGp1VXV1M3VqZnhocFVOTkxzb003ZXJRbE9pNUNhZ3pyMmkKSDR3dXI4c005YU9TQlgwQUVRRUFBYlFoVFdGeWF5Qk5aWEpqWVdSdklEeHRZVzFsY21OaFpFQm5iV0ZwYkM1agpiMjAraVFIVUJCTUJDQUErRmlFRUtpckE0a2xLWnZHUzhBSm5QbmpldU9wU0Q2a0ZBbUFrb3IwQ0d3TUZDUVBDClp3QUZDd2tJQndJR0ZRb0pDQXNDQkJZQ0F3RUNIZ0VDRjRBQUNna1FQbmpldU9wU0Q2blNiUXdBbzRUNGwvYTIKd2NsY2pGMnI2OFBxR1BPOE11bkppVzNxOHBlMG9FTmY3ZnZCVEdLbEUrMmlyejRzVmVBM1IvQzduOWwyajNVTgpKRjM2cHBCV0dFMzdJSGU4TW9VVUxrUzd0WXVLeGc0UXRaRFRiRTd5L3RCa3o0b0FLNW5lNEQzNmIzUnEyT1BhCmt6ZURLTjROUjNOc2J2NXQ4RExoZWQ5Q1JMZk1tdGZtb2xOSTRiNkpOblhhSkNYMzZTSmNrMUFaYkg1S3FvSSsKUHlyT1E0Sk9mWmV3U1lUNUtWSjR1Tzh6TGFNWE4wdTZjTFdreEZRZ1NPdCt0TlBqRVlIOUtnMVE3QURNREswYwpqUzN6SXVEYmFzZFNDaG5adXF4d1hVSmVvbVVadkVlWGs5dEhyU2tuWVRDNzhTWXl3a1pUOU54RHoyNXFhVzBuClBDTHZSWXhERFNydlNnbE4xYndMaUNiYTNDSHgweldSbTltcEVnWm5TZFJxU01sU0ZUMCtnU28raFFaejY4OEQKSWNhVEF2ZGhQcktZRDVoUURYMVE4c0JXM3lxUVY3Q2VlSmFVU1ZQOW94bEFyQ2VuSDg3Lzl6RUFFUWljTzFZWApMNjdXSWtWamJhUmdob2VWVks5M3c4M2o3V0hQU3dGd3dqMTI1VWlGTitYd3R1RGFONmZpZi9JMXVRR05CR0FrCm9yMEJEQURJY1I2WExEQ3RxeHZScE5YdjYyNDZjbHlkVFlKbGN6RDVETlR0RnRnSzcvRVBVWjBBMEw0dGxvTDAKbWJBSVJzM3A2aXRQNGJnR0lDTVI5U05SVDIrL2hCM1IraXlKM0lXMXhlSEl3WnpKRldXbTNGSnI1eThxSzFPdgpnenJ6M3QrSzAvd2ZDR0l3QVdRa0hQQkl0aDJPT0E3d05WVGlTRzlKY2VjazlqL3VtazJEVi9raFFsRlFJYU5oCnFMNEc0R09kOFVMbWcwK3RtY2pWVXVZYU1TWUE5aFBmSzVPc0l1czZZY3BtQ09ad3p4U3JxV25DODQrV3UrYU0KSU9uZzFXaUVSaS92MHQxVWQzQkVjOVhEQVAvN0x6OUNqQUpzV3BKbjlXSzc0K09VbjVrZ2Z3TitVN0NVd3FQZAppVC9OSGszUnI5K3lad1g3WnAzSGt1WXJTc2JjUlJtL2lRTXhmdVRrVTVtc0xlelVodXh6NC9vNHF1UHFlcXFpClVCa3dXMVNxQ1B5RUVHZWc2dEplQ1ltNjNmTkxIYmlERGtiVmFsSzhyTDZKeWFqL2V5cUxUOUp4L20xRFFDZ3YKdzRHdXFWeXg2TVY0N1N4M0l5bXpPdk9laU53cXJzVkRtN1pDL2t6WEFJY1lPZDV6VFZna2IwY3M0SlVzQzNucApycThNaTNzQUVRRUFBWWtCdkFRWUFRZ0FKaFloQkNvcXdPSkpTbWJ4a3ZBQ1p6NTQzcmpxVWcrcEJRSmdKS0s5CkFoc01CUWtEd21jQUFBb0pFRDU0M3JqcVVnK3B6RTBML2llSStXcUthLy9mSjh6N1ozUDBjUStTQ0JIdkk3Vm0KOGxCTnVyRmtIRllDS3hiSXlNV1BBM0dZK0hwNDR3TEdpUm50S05iZURxTVVUVStsWU5rbmNOb3psZFBhdHNGNApwSXhTM21UTzFIMU1xSzUrcU1rNkFaOUhwejVTYnpJOUFvbEVhajR2a2Qyc3krdXAzU1IvVkVSbkhFQ3duWEZDClhOMkRtRUFkZ3g0ZGMxbFNYdEpZSUp5RTFnaGpxQ005VkROeEphbEhCYk5tcjY0NzBHZit1UXJlaEptK05tYkkKYWwyQWkwVS94SzJ4d3RFbHdVbkxleXZPcm5GVjd3VEYzRkhMT1lQRTZLTTNpK210RG1CQUc0cS9UcFBwaGpjcwpKQUt0dVRwSk1WK3pmQ1NoNG5INEtBU1pBWlNJZ1BRMXQxdXo2WURRZStDQ25PN1BxZUFuSmpCNm9DUTcrcXljCjQ1QVVkcm9JbXhCaFJaTEhPMGt5Vy9MQzNSOWdBUXdqT2ZTbnBHb2lXQ2swZUV3Z2ZwdGtSVGZwOW5YN01zclIKWXFxRnIwTVF2SFM5YUVpTStLU1RrMnB0dHYvQUZUNnU0OVQ2YTgrSjVJTm5TYlJvdG13NTExY0lRMUtnOUdPSQpJdnIzazAxL3NxU21vV3FOVVBySFhISHlQQUF1OEFUd05nPT0KPTM0bEMKLS0tLS1FTkQgUEdQIFBVQkxJQyBLRVkgQkxPQ0stLS0tLQo=

      # https://assafmo.github.io/2019/05/02/ppa-repo-hosted-on-github.html
      - name: ppa
        run: |
          cd node_exporter-*.*-amd64
          dpkg-scanpackages --multiversion . > Packages
          gzip -k -f Packages
          apt-ftparchive release . > Release
          cp ../KEY.gpg .
          gpg --default-key "${EMAIL}" -abs -o - Release > Release.gpg
          gpg --default-key "${EMAIL}" --clearsign -o - Release > InRelease
          echo "deb https://${GITHUB_USERNAME}.github.io/node-exporter ./" > ${GITHUB_USERNAME}-node-exporter.list
          cat "${GITHUB_USERNAME}-node-exporter.list"
        env:
          EMAIL: mamercad@gmail.com
